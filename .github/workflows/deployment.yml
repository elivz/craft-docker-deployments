name: Deploy

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      domain:
        required: true
        type: string
      basic-auth:
        type: string
      health-check-path:
        type: string
        default: '/actions/app/health-check'
        description: 'Health check endpoint path'

env:
  GHCR_REGISTRY: ghcr.io
  GHCR_REPOSITORY: ${{ github.repository }}/web

jobs:
  # Job 1: Build and push Docker images
  build:
    name: Build and Push Images
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    outputs:
      slack-ts: ${{ steps.slack.outputs.ts }}
    steps:
      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.DEPLOY_HOST }}" ] || [ -z "${{ secrets.DEPLOY_USER }}" ] || [ -z "${{ secrets.DEPLOY_KEY }}" ]; then
            echo "Error: Missing required deployment secrets (DEPLOY_HOST, DEPLOY_USER, DEPLOY_KEY)"
            exit 1
          fi

      - name: Send started notification to Slack
        uses: slackapi/slack-github-action@v1.26.0
        if: ${{ vars.SLACK_WEBHOOK_URL != '' && vars.SLACK_CHANNEL_ID != '' }}
        id: slack
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          channel-id: ${{ vars.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "${{ github.workflow }} started (In Progress)",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ github.workflow }} started â³",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Environment*: `${{ inputs.environment }}`\n*Domain*: `${{ inputs.domain }}`\n*Workflow*: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Code Changes*: ${{ github.event.pull_request.html_url || github.event.head_commit.url }}"
                  }
                }
              ]
            }

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create .env file
        run: touch .env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push images
        id: build
        uses: docker/bake-action@v6
        with:
          files: docker-compose.ci.yml
          push: true
          set: |
            *.cache-from=type=registry,ref=${{ env.GHCR_REGISTRY }}/${{ env.GHCR_REPOSITORY }}:latest
            *.cache-from=type=gha,scope=cached-stage
            *.cache-to=type=gha,scope=cached-stage,mode=max
        env:
          BRANCH: ${{ inputs.environment }}

  # Job 2: Deploy containers and verify health
  deploy-and-verify:
    name: Deploy and Verify
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ inputs.environment }}
    timeout-minutes: 10
    outputs:
      current-color: ${{ steps.deploy.outputs.current-color }}
      target-color: ${{ steps.deploy.outputs.target-color }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy Docker configuration
        uses: easingthemes/ssh-deploy@main
        with:
          REMOTE_HOST: ${{ secrets.DEPLOY_HOST }}
          REMOTE_USER: ${{ secrets.DEPLOY_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_KEY }}
          ARGS: "-rltgoDzvO"
          SOURCE: "docker-compose.deployment.yml"
          TARGET: "${{ inputs.environment }}/docker-compose.yml"

      - name: Deploy containers with blue-green strategy
        id: deploy
        uses: appleboy/ssh-action@v1.0.3
        continue-on-error: true
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          command_timeout: 5m
          script: |
            set -e
            source ~/.bashrc
            
            # Setup environment
            mkdir -p ${{ inputs.environment }}
            cd ${{ inputs.environment }}
            
            # Login to registry
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login --username ${{ github.actor }} --password-stdin ${{ env.GHCR_REGISTRY }}
            
            # Configure docker-compose file
            sed -i -e "s|{BRANCH}|${{ inputs.environment }}|g" docker-compose.yml
            sed -i -e "s|{VIRTUAL_HOST}|${{ inputs.domain }}|g" docker-compose.yml
            sed -i -e "s|{GHCR_REGISTRY}|${{ env.GHCR_REGISTRY }}|g" docker-compose.yml
            sed -i -e "s|{GHCR_REPOSITORY}|${{ env.GHCR_REPOSITORY }}|g" docker-compose.yml
            
            # Determine current active color and target color for deployment
            echo "ðŸ” Determining current deployment state..."
            BLUE_RUNNING=$(docker compose ps --services --filter "status=running" | grep "web-blue" | wc -l)
            GREEN_RUNNING=$(docker compose ps --services --filter "status=running" | grep "web-green" | wc -l)
            
            if [ "$BLUE_RUNNING" -gt 0 ] && [ "$GREEN_RUNNING" -gt 0 ]; then
              echo "âš ï¸ Both blue and green are running. This shouldn't happen in normal operation."
              echo "ðŸ”´ Stopping green to ensure clean state..."
              docker compose stop web-green queue-green || true
              CURRENT_COLOR="blue"
              TARGET_COLOR="green"
            elif [ "$BLUE_RUNNING" -gt 0 ]; then
              CURRENT_COLOR="blue"
              TARGET_COLOR="green"
              echo "ðŸ”µ Current deployment: BLUE â†’ Deploying to: GREEN"
            elif [ "$GREEN_RUNNING" -gt 0 ]; then
              CURRENT_COLOR="green"
              TARGET_COLOR="blue"
              echo "ðŸŸ¢ Current deployment: GREEN â†’ Deploying to: BLUE"
            else
              # No active deployment, start with blue
              CURRENT_COLOR="none"
              TARGET_COLOR="blue"
              echo "ðŸ†• No active deployment found â†’ Deploying to: BLUE"
            fi
            
            # Output deployment info for use in other steps
            echo "current-color=$CURRENT_COLOR" >> $GITHUB_OUTPUT
            echo "target-color=$TARGET_COLOR" >> $GITHUB_OUTPUT
            
            # Pull new images
            echo "ðŸ“¥ Pulling new images..."
            docker compose pull -q
            
            # Start target color services
            echo "ðŸš€ Starting $TARGET_COLOR services..."
            docker compose up --detach --no-build web-$TARGET_COLOR queue-$TARGET_COLOR redis --wait
            
            echo "â³ Waiting for $TARGET_COLOR services to be ready..."
            sleep 10
            
            # Verify target services are healthy
            TARGET_HEALTHY=$(docker compose ps --services --filter "status=running" | grep "web-$TARGET_COLOR" | wc -l)
            if [ "$TARGET_HEALTHY" -eq 0 ]; then
              echo "âŒ Target $TARGET_COLOR service failed to start"
              exit 1
            fi
            
            echo "âœ… $TARGET_COLOR services are running"
            
            # Note: nginx-proxy will automatically start load balancing between both colors
            # We'll verify health externally, then stop the old color

      - name: Health Check
        id: health-check
        if: steps.deploy.outcome == 'success'
        uses: jtalk/url-health-check-action@v4
        with:
          url: https://${{ inputs.domain }}${{ inputs.health-check-path }}
          max-attempts: 6
          retry-delay: 5s
          basic-auth: ${{ inputs.basic-auth }}

      - name: Complete blue-green deployment
        id: complete-deployment
        if: steps.deploy.outcome == 'success' && steps.health-check.outcome == 'success'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          command_timeout: 2m
          script: |
            set -e
            source ~/.bashrc
            cd ${{ inputs.environment }}
            
            CURRENT_COLOR="${{ steps.deploy.outputs.current-color }}"
            TARGET_COLOR="${{ steps.deploy.outputs.target-color }}"
            
            echo "ðŸ”„ Completing blue-green deployment..."
            echo "Current: $CURRENT_COLOR â†’ Target: $TARGET_COLOR"
            
            if [ "$CURRENT_COLOR" != "none" ]; then
              echo "â¹ï¸ Stopping old $CURRENT_COLOR services..."
              docker compose stop web-$CURRENT_COLOR queue-$CURRENT_COLOR
              
              # Wait a moment for graceful shutdown
              sleep 5
              
              echo "ðŸ§¹ Removing old $CURRENT_COLOR containers..."
              docker compose rm -f web-$CURRENT_COLOR queue-$CURRENT_COLOR
            fi
            
            echo "âœ… Blue-green deployment completed successfully!"
            echo "ðŸŽ¯ Active deployment: $TARGET_COLOR"

      - name: Rollback on failure
        if: always() && (steps.deploy.outcome == 'failure' || steps.health-check.outcome == 'failure')
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          command_timeout: 120s
          script: |
            set -e
            source ~/.bashrc
            cd ${{ inputs.environment }}
            
            CURRENT_COLOR="${{ steps.deploy.outputs.current-color }}"
            TARGET_COLOR="${{ steps.deploy.outputs.target-color }}"
            
            echo "ðŸš¨ Deployment or health check failed, initiating blue-green rollback..."
            echo "Rollback info - Current: $CURRENT_COLOR, Failed Target: $TARGET_COLOR"
            
            # Stop the failed target deployment
            echo "â¹ï¸ Stopping failed $TARGET_COLOR services..."
            docker compose stop web-$TARGET_COLOR queue-$TARGET_COLOR || true
            docker compose rm -f web-$TARGET_COLOR queue-$TARGET_COLOR || true
            
            if [ "$CURRENT_COLOR" != "none" ]; then
              # Ensure the previous working color is still running
              echo "ðŸ” Verifying $CURRENT_COLOR services are running..."
              CURRENT_RUNNING=$(docker compose ps --services --filter "status=running" | grep "web-$CURRENT_COLOR" | wc -l)
              if [ "$CURRENT_RUNNING" -eq 0 ]; then
                echo "ðŸ”„ Restarting $CURRENT_COLOR services..."
                docker compose up --detach --no-build web-$CURRENT_COLOR queue-$CURRENT_COLOR redis --wait
              fi
              echo "âœ… Rollback completed - $CURRENT_COLOR is active"
            else
              echo "âŒ No previous deployment to rollback to"
              exit 1
            fi

      - name: Mark deployment as failed
        if: steps.deploy.outcome == 'failure' || steps.health-check.outcome == 'failure'
        run: |
          echo "::error::Deployment failed and rollback was attempted"
          exit 1
          

  # Job 3: Clean up old images
  cleanup-images:
    name: Cleanup old images
    runs-on: ubuntu-latest
    needs: deploy-and-verify
    steps:
      - name: Remove old untagged images
        uses: actions/delete-package-versions@v5
        with:
          package-name: "${{ github.event.repository.name }}/web"
          package-type: 'container'
          min-versions-to-keep: 10
          ignore-versions: '^[a-zA-Z-]+$'

  # Job 3: Run database migrations and clear caches
  migrate:
    name: Run Migrations
    runs-on: ubuntu-latest
    needs: deploy-and-verify
    environment: ${{ inputs.environment }}
    timeout-minutes: 30
    steps:
      - name: Run Craft migrations and clear caches
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          command_timeout: 25m
          script: |
            set -e
            source ~/.bashrc
            cd ${{ inputs.environment }}
            
            # Determine which color is currently active
            BLUE_RUNNING=$(docker compose ps --services --filter "status=running" | grep "web-blue" | wc -l)
            GREEN_RUNNING=$(docker compose ps --services --filter "status=running" | grep "web-green" | wc -l)
            
            if [ "$BLUE_RUNNING" -gt 0 ] && [ "$GREEN_RUNNING" -eq 0 ]; then
              ACTIVE_COLOR="blue"
            elif [ "$GREEN_RUNNING" -gt 0 ] && [ "$BLUE_RUNNING" -eq 0 ]; then
              ACTIVE_COLOR="green"
            else
              echo "âŒ Unable to determine active color. Blue: $BLUE_RUNNING, Green: $GREEN_RUNNING"
              exit 1
            fi
            
            echo "ðŸ—ƒï¸ Running migrations on active $ACTIVE_COLOR deployment..."
            docker compose exec -T web-$ACTIVE_COLOR php craft up --interactive=0
            
            echo "ðŸ§¹ Clearing caches..."
            docker compose exec -T web-$ACTIVE_COLOR php craft clear-caches/compiled-classes --interactive=0
            docker compose exec -T web-$ACTIVE_COLOR php craft clear-caches/compiled-templates --interactive=0
            docker compose exec -T web-$ACTIVE_COLOR php craft invalidate-tags/all --interactive=0
            
            echo "âœ… Migrations and cache clearing completed"

  # Job 4: Send notifications
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [build, deploy-and-verify, migrate]
    if: always()
    steps:
      - name: Determine workflow status
        id: status
        run: |
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "icon=ðŸš¨" >> $GITHUB_OUTPUT
            echo "message=failed" >> $GITHUB_OUTPUT
          elif [[ "${{ contains(needs.*.result, 'cancelled') }}" == "true" ]]; then
            echo "status=cancelled" >> $GITHUB_OUTPUT
            echo "icon=â¹ï¸" >> $GITHUB_OUTPUT
            echo "message=cancelled" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "icon=âœ…" >> $GITHUB_OUTPUT
            echo "message=completed successfully" >> $GITHUB_OUTPUT
          fi

      - name: Send notification to Slack
        uses: slackapi/slack-github-action@v1.26.0
        if: ${{ vars.SLACK_WEBHOOK_URL != '' && vars.SLACK_CHANNEL_ID != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          channel-id: ${{ vars.SLACK_CHANNEL_ID }}
          update-ts: ${{ needs.build.outputs.slack-ts }}
          payload: |
            {
              "text": "${{ github.workflow }} ${{ steps.status.outputs.message }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ github.workflow }} ${{ steps.status.outputs.message }} ${{ steps.status.outputs.icon }}",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Environment*: `${{ inputs.environment }}`\n*Domain*: `${{ inputs.domain }}`\n*Status*: ${{ steps.status.outputs.status }}\n*Workflow*: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Code Changes*: ${{ github.event.pull_request.html_url || github.event.head_commit.url }}"
                  }
                }
              ]
            }
