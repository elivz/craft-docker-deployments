name: Deploy

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      domain:
        required: true
        type: string
      basic-auth:
        type: string

jobs:
  # Job 1: Notify start and build/push Docker images
  build:
    name: Build and Push Images
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    env:
      GHCR_REGISTRY: ghcr.io
      GHCR_REPOSITORY: ${{ github.repository }}/web
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
    outputs:
      slack-ts: ${{ steps.slack.outputs.ts }}
    steps:
      - name: Send started notification to Slack
        uses: slackapi/slack-github-action@v1.26.0
        if: ${{ env.SLACK_WEBHOOK_URL != '' && env.SLACK_CHANNEL_ID != '' }}
        id: slack
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }}
          payload: |
            {
              "text": "${{ github.workflow }} started (In Progress)",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ github.workflow }} started ‚è≥",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Workflow*: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Code Changes*: ${{ github.event.pull_request.html_url || github.event.head_commit.url }}"
                  }
                }
              ]
            }
      - uses: actions/checkout@v4
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Touch .env # Docker will fail if a .env doesn't exist at build even though it is not copied into the container
        run: touch .env
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push images
        uses: docker/bake-action@v6
        with:
          files: docker-compose.ci.yml
          push: true
          set: |
            *.cache-from=type=registry,ref=${{ env.GHCR_REGISTRY }}/${{ env.GHCR_REPOSITORY }}:latest
            *.cache-from=type=gha,scope=cached-stage
            *.cache-to=type=gha,scope=cached-stage,mode=max
        env:
          BRANCH: ${{ inputs.environment }}

  # Job 2: Deploy containers to server and verify health
  deploy-and-verify:
    name: Deploy and Verify
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ inputs.environment }}
    env:
      GHCR_REGISTRY: ghcr.io
      GHCR_REPOSITORY: ${{ github.repository }}/web
    steps:
      - uses: actions/checkout@v4
      - name: Copy Docker configuration
        uses: easingthemes/ssh-deploy@main
        with:
          REMOTE_HOST: ${{ secrets.DEPLOY_HOST }}
          REMOTE_USER: ${{ secrets.DEPLOY_USER }}
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_KEY }}
          ARGS: "-rltgoDzvO"
          SOURCE: "docker-compose.deployment.yml"
          TARGET: "${{ inputs.environment }}/docker-compose.yml"
      - name: Pull images and restart containers
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -e
            source ~/.bashrc
            mkdir -p ${{ inputs.environment }}
            cd ${{ inputs.environment }}
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login --username ${{ github.actor }} --password-stdin ${{ env.GHCR_REGISTRY }}
            sed -i -e "s/{BRANCH}/${{ inputs.environment }}/g" docker-compose.yml
            sed -i -e "s/{VIRTUAL_HOST}/${{ inputs.domain }}/g" docker-compose.yml
            # Set GHCR environment variables for docker-compose
            export GHCR_REGISTRY="${{ env.GHCR_REGISTRY }}"
            export GHCR_REPOSITORY="${{ env.GHCR_REPOSITORY }}"
            # Pull down new images
            docker compose pull -q
            docker compose up --detach --no-build --wait --remove-orphans
      - name: Health Check
        id: health-check
        uses: jtalk/url-health-check-action@v4
        with:
          url: https://${{ inputs.domain }}/actions/app/health-check
          max-attempts: 4
          retry-delay: 5s
          basic-auth: ${{ inputs.basic-auth }}
      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script: |
            set -e
            source ~/.bashrc
            cd ${{ inputs.environment }}
            echo "Health check failed, rolling back to previous image..."
            docker compose down
            docker image prune -f
            docker compose up --detach --wait

  # Job 3: Run database migrations and clear caches
  migrate:
    name: Run Migrations
    runs-on: ubuntu-latest
    needs: deploy-and-verify
    environment: ${{ inputs.environment }}
    steps:
      - name: Run Craft database migrations and clear caches
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          command_timeout: 30m
          script: |
            set -e
            source ~/.bashrc
            cd ${{ inputs.environment }}
            docker compose exec web php craft up --interactive=0
            docker compose exec web php craft clear-caches/compiled-classes --interactive=0
            docker compose exec web php craft clear-caches/compiled-templates --interactive=0
            docker compose exec web php craft invalidate-tags/all --interactive=0


  # Job 4: Send notifications based on overall workflow status
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
    needs: [build, deploy-and-verify, migrate]
    if: always()
    steps:
      - name: Send failure notification to Slack
        uses: slackapi/slack-github-action@v1.26.0
        if: ${{ contains(needs.*.result, 'failure') && env.SLACK_WEBHOOK_URL != '' && env.SLACK_CHANNEL_ID != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }}
          update-ts: ${{ needs.build.outputs.slack-ts }}
          payload: |
            {
              "text": "${{ github.workflow }} finished (Failed)",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ github.workflow }} failed üö®",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Workflow*: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Code Changes*: ${{ github.event.pull_request.html_url || github.event.head_commit.url }}"
                  }
                }
              ]
            }
      - name: Send success notification to Slack
        uses: slackapi/slack-github-action@v1.26.0
        if: ${{ !contains(needs.*.result, 'failure') && env.SLACK_WEBHOOK_URL != '' && env.SLACK_CHANNEL_ID != '' }}
        with:
          channel-id: ${{ env.SLACK_CHANNEL_ID }}
          update-ts: ${{ needs.build.outputs.slack-ts }}
          payload: |
            {
              "text": "${{ github.workflow }} finished (Completed)",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ github.workflow }} finished ‚úÖ",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Workflow*: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Code Changes*: ${{ github.event.pull_request.html_url || github.event.head_commit.url }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ env.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
